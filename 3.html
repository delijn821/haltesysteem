
<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Lijn X60 - Brussel Noord</title>
<style>

@font-face {
    font-family: 'FlandersArtSans';
    src: url('fonts/FlandersArtSans-Bold.woff') format('woff');
    font-weight: 600;
    font-style: normal;
}

@font-face {
    font-family: 'FlandersArtSans';
    src: url('fonts/FlandersArtSans-Medium.woff') format('woff');
    font-weight: 500;
    font-style: normal;
}

@font-face {
    font-family: 'FlandersArtSans';
    src: url('fonts/FlandersArtSans-Regular.woff') format('woff');
    font-weight: 400;
    font-style: normal;
}

body {
    font-family: 'FlandersArtSans', Arial, sans-serif;
    background-color: #111;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    height: 100vh;
    margin: 0;
    overflow: hidden;
    padding-top: 2.75%;
    padding-left: 5%;
    padding-right: 5%;
}

.header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.line-info {
    display: flex;
    align-items: center;
    gap: 20px;
}

.line-box {
    background-color: #E6007E;
    color: #FFFFFF;
    -webkit-text-stroke: 2px #000;
    padding: 5px 20px;
    border-radius: 25px;
    font-size: 4.75em;
    font-weight: 600;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
}

.destination {
    font-size: 3.75em;
    font-weight: 500;
}

.clock {
    font-size: 3.5em;
    font-weight: 400;
}

.stops {
    display: flex;
    padding-top: 3%;
    flex-grow: 1;
    overflow: hidden;
    flex-direction: column;
    gap: 15px;
    font-size: 2.25em;
    font-weight: 500;
    width: 100%;
    text-align: left;
}

.stop {
    background-color: #333;
    border-radius: 15px;
    padding: 15px;
}

.footer {
    font-size: 3em;
    font-weight: 500;
    margin-top: auto;
    margin-bottom: 3.25%;
    width: 100%;
    text-align: center;
    padding: 2%;
    border-top: 2px solid #444;
}

.current-stop {
    font-size: 2em;
    font-weight: 500;
    margin-top: 3.25%;
    margin-bottom: 3.25%;
    width: 100%;
    text-align: center;
    padding: 2%;
}

.stops-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
    width: 100%;
}

.timeline {
    position: absolute;
    left: 36px;
    width: 6px;
    background-color: #fff;
    border-radius: 2px;
    z-index: 0;
    top: 45px;
    bottom: 30px;
}

.stop {
    position: relative;
    display: flex;
    align-items: center;
    background-color: #333;
    border-radius: 15px;
    padding: 15px 15px 15px 60px;
    z-index: 1;
}

.stop::before {
    content: "";
    position: absolute;
    left: 25px;
    width: 20px;
    height: 20px;
    background-color: #111;
    border: 5px solid #fff;
    border-radius: 50%;
    transform: translateY(-50%);
    top: 50%;
}

.stop.first::before {
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { transform: translateY(-50%) scale(1.0); }
    50% { transform: translateY(-50%) scale(1.3); }
}

.stop {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #333;
    border-radius: 15px;
    padding: 15px 25px 15px 60px;
}

.stop-name {
    flex-grow: 1;
    text-align: left;
}

.stop-time {
    font-size: 0.8em;
    color: #ccc;
    text-align: right;
    min-width: 80px;
}


</style>
</head>
<body>
<div class="header">
    <div class="line-info">
        <span class="line-box">X60</span>
        <span class="destination">Brussel Noord</span>
    </div>
    <div class="clock" id="clock"></div>
</div>

<div class="stops-container">
    <div class="timeline"></div>
    <div class="stops" id="stops-container"></div>
</div>

<div class="footer" id="next-stop">Volgende halte: â€”</div>

<script>
const haltes = [{"stop_name": "Boom Station perron 1", "departure_time": "16:55:00", "stop_lat": 51.090203, "stop_lon": 4.360282}, {"stop_name": "Boom Markt", "departure_time": "16:58:00", "stop_lat": 51.086262, "stop_lon": 4.361767}, {"stop_name": "Willebroek Klein Willebroek", "departure_time": "16:58:00", "stop_lat": 51.083962, "stop_lon": 4.359782}, {"stop_name": "Willebroek Brico", "departure_time": "17:01:00", "stop_lat": 51.077022, "stop_lon": 4.352837}, {"stop_name": "Willebroek Appeldonkstraat", "departure_time": "17:02:00", "stop_lat": 51.072643, "stop_lon": 4.348207}, {"stop_name": "Willebroek Station perron 1", "departure_time": "17:04:00", "stop_lat": 51.066841, "stop_lon": 4.354983}, {"stop_name": "Willebroek Bibliotheek", "departure_time": "17:08:00", "stop_lat": 51.062421, "stop_lon": 4.359281}, {"stop_name": "Willebroek Bosbeek", "departure_time": "17:11:00", "stop_lat": 51.059821, "stop_lon": 4.352462}, {"stop_name": "Willebroek Fort van Breendonk", "departure_time": "17:13:00", "stop_lat": 51.059143, "stop_lon": 4.344796}, {"stop_name": "Breendonk De Winning", "departure_time": "17:16:00", "stop_lat": 51.060035, "stop_lon": 4.331326}, {"stop_name": "Breendonk Rijweg", "departure_time": "17:17:00", "stop_lat": 51.057957, "stop_lon": 4.335206}, {"stop_name": "Breendonk Schaafstraat", "departure_time": "17:19:00", "stop_lat": 51.052247, "stop_lon": 4.332763}, {"stop_name": "Breendonk Vrijhals", "departure_time": "17:21:00", "stop_lat": 51.046933, "stop_lon": 4.328252}, {"stop_name": "Breendonk Gemeentehuis", "departure_time": "17:22:00", "stop_lat": 51.042502, "stop_lon": 4.325915}, {"stop_name": "Breendonk Vijfhoek", "departure_time": "17:23:00", "stop_lat": 51.038582, "stop_lon": 4.325853}, {"stop_name": "Breendonk Sint-Jozefstraat", "departure_time": "17:25:00", "stop_lat": 51.034446, "stop_lon": 4.323662}, {"stop_name": "Londerzeel Molenhoek", "departure_time": "17:28:00", "stop_lat": 51.023221, "stop_lon": 4.315597}, {"stop_name": "Londerzeel Industrie", "departure_time": "17:30:00", "stop_lat": 51.01759, "stop_lon": 4.315416}, {"stop_name": "Londerzeel Politiehuis", "departure_time": "17:32:00", "stop_lat": 51.012986, "stop_lon": 4.311241}, {"stop_name": "Londerzeel Zwembad", "departure_time": "17:34:00", "stop_lat": 51.011126, "stop_lon": 4.30526}, {"stop_name": "Londerzeel Egmont & Hoorn", "departure_time": "17:35:00", "stop_lat": 51.011367, "stop_lon": 4.298611}, {"stop_name": "Londerzeel Station perron 2", "departure_time": "17:36:00", "stop_lat": 51.008786, "stop_lon": 4.29838}, {"stop_name": "Londerzeel Chrysantenlaan", "departure_time": "17:37:00", "stop_lat": 51.005627, "stop_lon": 4.302018}, {"stop_name": "Londerzeel Lode Meeusplein", "departure_time": "17:37:00", "stop_lat": 51.002923, "stop_lon": 4.303285}, {"stop_name": "Londerzeel Rustoord", "departure_time": "17:38:00", "stop_lat": 51.002473, "stop_lon": 4.306228}, {"stop_name": "Londerzeel Acacialaan", "departure_time": "17:38:00", "stop_lat": 51.000991, "stop_lon": 4.309619}, {"stop_name": "Londerzeel Kerkhofstraat/A12", "departure_time": "17:39:00", "stop_lat": 50.998205, "stop_lon": 4.315019}, {"stop_name": "Brussel Karel Bogaerd", "departure_time": "18:02:00", "stop_lat": 50.881229, "stop_lon": 4.34842}, {"stop_name": "Brussel Station Bockstael", "departure_time": "18:02:00", "stop_lat": 50.879885, "stop_lon": 4.347623}, {"stop_name": "Brussel Bockstael", "departure_time": "18:04:00", "stop_lat": 50.876003, "stop_lon": 4.348201}, {"stop_name": "Brussel Suzan Daniel", "departure_time": "18:11:00", "stop_lat": 50.862985, "stop_lon": 4.348659}, {"stop_name": "Brussel Noord afstaphalte", "departure_time": "18:16:00", "stop_lat": 50.859321, "stop_lon": 4.359647}];
// index van de halte die momenteel als "huidige" wordt beschouwd in de lijst
let lastClosestIndex = 0;
// onthoud vorige afstand naar "next" stop om te vergelijken of die afneemt
let prevNextDist = null;
// onthoud vorige afstand naar "current" (optioneel, kan gebruikt voor logging/extra checks)
let prevCurrentDist = null;
let lastDistanceToCurrent = null;
let currentStopScreen = false;
let sanityInterval = 300000;
let previousDistanceToNext = null; 
let updateCounter = 0;  // telt hoeveel keer updateHaltes is aangeroepen
// const sanityEvery = 60;  // voer sanityCheck uit elke 5 haltes

// Update klok
function updateClock() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    document.getElementById('clock').textContent = hours + ':' + minutes;
}
setInterval(updateClock, 1000);
updateClock();

// Bereken afstand tussen 2 GPS-coÃ¶rdinaten (Haversine) -> meter
function distance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Render functie die de zichtbare haltes in DOM plaatst
function renderStops(startIndex) {
    const visible = haltes.slice(startIndex, startIndex + 5);
    const container = document.getElementById('stops-container');
    // Zorg dat de verticale lijn opnieuw zichtbaar is bij normale weergave
    document.querySelector('.timeline').style.display = 'block';
    container.innerHTML = '';
    visible.forEach((h, i) => {
        const div = document.createElement('div');
        div.className = 'stop';
        if (i === 0) div.classList.add('first'); // eerste halte krijgt pulserende bol
        div.innerHTML = `
            <span class="stop-name">${h.stop_name}</span>
            <span class="stop-time">${h.departure_time ? h.departure_time.slice(0,5) : ""}</span>
        `;
        container.appendChild(div);
    });

    const nextStop = visible.length > 1 ? visible[0].stop_name : 'Eindhalte bereikt';
    document.getElementById('next-stop').textContent = "Volgende halte: " + nextStop;
}

// initial render
renderStops(lastClosestIndex);

// Vraag GPS-locatie van apparaat en update
function getLocationAndUpdate() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                updateHaltes(lat, lon);
            },
            err => {
                console.warn("GPS-fout: " + err.message);
                // fallback op eerste halte
                updateHaltes(parseFloat(haltes[0].stop_lat), parseFloat(haltes[0].stop_lon));
            },
            {
                enableHighAccuracy: true,
                maximumAge: 5000,
                timeout: 10000
            }
        );
    } else {
        console.warn("Geolocatie niet ondersteund");
        updateHaltes(parseFloat(haltes[0].stop_lat), parseFloat(haltes[0].stop_lon));
    }
}

function renderCurrentStop(currentIndex) {
    const container = document.getElementById('stops-container');
    // Toon de verticale lijn terug bij normale weergave
    document.querySelector('.timeline').style.display = 'none';
    const currentStop = haltes[currentIndex];
    const nextIndex = Math.min(currentIndex + 1, haltes.length - 1);
    const nextStop = haltes[nextIndex];

    // Standaard stops verbergen
    container.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'current-stop';
    div.innerHTML = "Huidige halte:<br>" + currentStop.stop_name;
    container.appendChild(div);

    // Footer aanpassen
    document.getElementById('next-stop').textContent =
        "Volgende halte: " + (nextStop ? nextStop.stop_name : "Eindhalte bereikt");
}

function updateHaltes(userLat, userLon) {
    if (!haltes || haltes.length === 0) return;
    // === Sanitycheck: spring naar dichtstbijzijnde halte binnen 30 m ===
    let nearestIndex = null;
    let minDistance = Infinity;

    haltes.forEach((stop, i) => {
        const d = distance(userLat, userLon, stop.stop_lat, stop.stop_lon);
        if (d < minDistance) {
            minDistance = d;
            nearestIndex = i;
        }
});

// als gebruiker binnen 30 m van eender welke halte is â†’ spring daarheen
if (minDistance <= 30 && nearestIndex !== lastClosestIndex) {
    lastClosestIndex = nearestIndex;
    renderStops(lastClosestIndex);
    console.log("ðŸŽ¯ Gesprongen naar halte binnen 30 m:", haltes[lastClosestIndex].stop_name);
    return; // stop verdere verwerking
}
    const currentIndex = lastClosestIndex;
    const nextIndex = Math.min(currentIndex + 1, haltes.length - 1);

    const currentStop = haltes[currentIndex];
    const nextStop = haltes[nextIndex];

    const distCurrent = distance(userLat, userLon, currentStop.stop_lat, currentStop.stop_lon);
    const distNext = nextStop ? distance(userLat, userLon, nextStop.stop_lat, nextStop.stop_lon) : Infinity;

    // Check of in de buurt van de huidige halte zijn
    if (distCurrent <= 60) {
        renderCurrentStop(currentIndex);
    } else {
        // Normale layout
        renderStops(currentIndex);
    }

    // Opschuif-logica
    if (distCurrent > 30 && lastDistanceToCurrent !== null && distCurrent > lastDistanceToCurrent && distNext < previousDistanceToNext) {
        lastClosestIndex = nextIndex;
        renderStops(lastClosestIndex);
        console.log("âž¡ï¸ Opschuiven naar:", haltes[lastClosestIndex].stop_name);
    }

    lastDistanceToCurrent = distCurrent;
    previousDistanceToNext = distNext;

    updateCounter++;

    if (updateCounter % sanityEvery === 0) {
    sanityCheck(userLat, userLon)
    }
}

function sanityCheck(userLat, userLon) {
    if (!haltes || haltes.length === 0) return;

    // Controleer de afstand tot vorige, huidige en volgende halte
    const prevIndex = Math.max(0, lastClosestIndex - 1);
    const nextIndex = Math.min(lastClosestIndex + 1, haltes.length - 1);

    const distPrev = distance(userLat, userLon, haltes[prevIndex].stop_lat, haltes[prevIndex].stop_lon);
    const distCurrent = distance(userLat, userLon, haltes[lastClosestIndex].stop_lat, haltes[lastClosestIndex].stop_lon);
    const distNext = distance(userLat, userLon, haltes[nextIndex].stop_lat, haltes[nextIndex].stop_lon);

    let proposedIndex = lastClosestIndex;

    // Als de gebruiker duidelijk dichter bij een andere halte is, corrigeer lastClosestIndex
    if (distPrev + 10 < distCurrent) proposedIndex = prevIndex;
    else if (distNext + 10 < distCurrent) proposedIndex = nextIndex;
    
    if (proposedIndex !== lastClosestIndex) {
        lastClosestIndex = proposedIndex;
        console.log("ðŸ”„ Sanity-correctie:", haltes[lastClosestIndex].stop_name);
    }
}

// Wacht na het laden van de pagina om de dichtstbijzijnde halte te bepalen
setTimeout(() => {
    console.log("â±ï¸ Bepaal dichtstbijzijnde halte...");

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => {
                const userLat = pos.coords.latitude;
                const userLon = pos.coords.longitude;

                let closestIndex = 0;
                let minDistance = Infinity;

                haltes.forEach((stop, i) => {
                    const d = distance(userLat, userLon, stop.stop_lat, stop.stop_lon);
                    if (d < minDistance) {
                        minDistance = d;
                        closestIndex = i;
                    }
                });

                lastClosestIndex = closestIndex;
                console.log("ðŸŽ¯ Start bij halte:", haltes[closestIndex].stop_name, "(", minDistance.toFixed(1), "m )");
                renderStops(lastClosestIndex);
            },
            err => console.warn("Locatie niet beschikbaar:", err.message)
        );
    } else {
        console.warn("Geolocatie niet ondersteund");
    }
}, 2000); // wachten

// eerste aanroep + interval
getLocationAndUpdate();
setInterval(getLocationAndUpdate, 1500);
</script>
</body>
</html>
