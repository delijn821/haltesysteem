<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Haltes opvragen - De Lijn</title>
  <style>
    :root {
      --primary: #004b87;
      --secondary: #f1f1f1;
      --highlight: #ffcc00;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      background: #fff;
      color: #333;
    }

    #formContainer {
      width: 25%;
      padding: 20px;
      background-color: var(--secondary);
      border-right: 2px solid #ccc;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #formContainer h1 {
      margin-top: 0;
      font-size: 1.5em;
      color: var(--primary);
    }

    label {
      display: block;
      margin-top: 10px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      background-color: var(--primary);
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #003f73;
    }

    #fullscreenBtn {
      margin-top: auto;
      padding: 10px;
      font-size: 1em;
      background-color: #666;
    }

    #resultaat {
      width: 75%;
      padding: 20px;
      overflow-y: auto;
      position: relative;
    }

    .halteList {
      margin-top: 20px;
    }

    .halte {
      padding: 8px 0;
      transition: font-size 0.3s ease;
    }

    .halte.huidig {
      font-size: 2em;
      font-weight: bold;
      color: var(--primary);
    }

    .halte.volgende-1 { font-size: 1.6em; }
    .halte.volgende-2 { font-size: 1.5em; }
    .halte.volgende-3 { font-size: 1.4em; }
    .halte.volgende-4 { font-size: 1.3em; }
    .halte.volgende-5 { font-size: 1.2em; }
    .halte.volgende-6 { font-size: 1.1em; }
    .halte.volgende-7 { font-size: 1.05em; }
    .halte.volgende-8 { font-size: 1em; }

    .pijlen {
      position: absolute;
      top: 20px;
      left: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pijlen button {
      padding: 10px;
      font-size: 1.2em;
      width: 40px;
      background-color: var(--highlight);
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .gemeente {
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<div id="formContainer">
  <h1>Haltes</h1>
  <form id="halteForm">
    <label>Entiteit:<input type="text" id="entiteit" required></label>
    <label>Lijnnummer:<input type="text" id="lijnnummer" required></label>
    <label>Richting:
      <select id="richting" required>
        <option value="HEEN">HEEN</option>
        <option value="TERUG">TERUG</option>
      </select>
    </label>
    <button type="submit">Toon haltes</button>
  </form>

  <div id="locatieControls">
    <button id="vernieuwLocatie">Locatie vernieuwen</button>
    <div class="toggle">
      <input type="checkbox" id="autoRefresh" />
      <label for="autoRefresh">Automatisch</label>
    </div>
  </div>

  <button id="fullscreenBtn">ðŸ”³ Volledig scherm</button>
</div>

<div id="resultaat">
  <div class="pijlen">
    <button id="pijlOmhoog">â–²</button>
    <button id="pijlOmlaag">â–¼</button>
  </div>
  <div id="halteLijst" class="halteList"></div>
</div>

<script>
  let haltes = [];
  let markerIndex = 0;

  async function getUserLocation() {
    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(
        pos => resolve(pos.coords),
        err => reject(err),
        { enableHighAccuracy: true, timeout: 10000 }
      );
    });
  }

  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const Ï†1 = lat1 * Math.PI / 180;
    const Ï†2 = lat2 * Math.PI / 180;
    const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
    const Î”Î» = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
              Math.cos(Ï†1) * Math.cos(Ï†2) *
              Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function markeerDichtstbijzijndeHalte(userCoords) {
    let minAfstand = Infinity;
    haltes.forEach((h, i) => {
      const afstand = calculateDistance(userCoords.latitude, userCoords.longitude, h.geoCoordinaat.latitude, h.geoCoordinaat.longitude);
      if (afstand < minAfstand) {
        markerIndex = i;
        minAfstand = afstand;
      }
    });
    toonHaltes();
  }

  function toonHaltes() {
    const lijst = document.getElementById('halteLijst');
    lijst.innerHTML = "";

    haltes.forEach((halte, index) => {
      const div = document.createElement('div');
      div.className = 'halte';

      if (index === markerIndex) {
        div.classList.add('huidig');
        div.textContent = `${halte.omschrijvingGemeente}, ${halte.omschrijvingLang || halte.omschrijving}`;
      } else if (index > markerIndex && index <= markerIndex + 8) {
        const volgNr = index - markerIndex;
        div.classList.add(`volgende-${volgNr}`);
        div.textContent = halte.omschrijvingLang || halte.omschrijving;
      } else {
        div.textContent = halte.omschrijvingLang || halte.omschrijving;
      }

      lijst.appendChild(div);
    });
  }

  document.getElementById('halteForm').addEventListener('submit', async e => {
    e.preventDefault();
    const entiteit = document.getElementById('entiteit').value;
    const lijnnummer = document.getElementById('lijnnummer').value;
    const richting = document.getElementById('richting').value;
    const url = `https://api.delijn.be/DLKernOpenData/api/v1/lijnen/${entiteit}/${lijnnummer}/lijnrichtingen/${richting}/haltes`;
    const apiKey = "ee23ac060f8a4038ad6d69358d85a1b0";

    try {
      const response = await fetch(url, {
        headers: {
          "Cache-Control": "no-cache",
          "Ocp-Apim-Subscription-Key": apiKey
        }
      });
      const data = await response.json();
      haltes = data.haltes;

      try {
        const userCoords = await getUserLocation();
        markeerDichtstbijzijndeHalte(userCoords);
      } catch {
        markerIndex = 0;
        toonHaltes();
      }
    } catch (err) {
      document.getElementById('halteLijst').innerHTML = `<p style="color:red;">Fout: ${err.message}</p>`;
    }
  });

  document.getElementById('vernieuwLocatie').addEventListener('click', async () => {
    try {
      const coords = await getUserLocation();
      markeerDichtstbijzijndeHalte(coords);
    } catch {
      alert("Locatie niet beschikbaar.");
    }
  });

  document.getElementById('autoRefresh').addEventListener('change', function () {
    if (this.checked) {
      setInterval(async () => {
        try {
          const coords = await getUserLocation();
          markeerDichtstbijzijndeHalte(coords);
        } catch {}
      }, 15000);
    }
  });

  document.getElementById('pijlOmhoog').addEventListener('click', () => {
    if (markerIndex > 0) markerIndex--;
    toonHaltes();
  });

  document.getElementById('pijlOmlaag').addEventListener('click', () => {
    if (markerIndex < haltes.length - 1) markerIndex++;
    toonHaltes();
  });

  document.getElementById('fullscreenBtn').addEventListener('click', () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  });
</script>

</body>
</html>
