<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Haltes opvragen - De Lijn</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
        }
        #formContainer {
            width: 30%;
            padding: 20px;
            background-color: #f9f9f9;
            border-right: 1px solid #ccc;
        }
        #halteForm label,
        #locatieControls label {
            display: block;
            margin-top: 10px;
        }
        #resultaat {
            width: 70%;
            padding: 20px;
            overflow-y: auto;
            height: 100vh;
        }
        ul {
            list-style: none;
            padding-left: 0;
        }
        li {
            margin-bottom: 5px;
            padding: 5px;
        }
        .gemeente {
            font-weight: bold;
            margin-top: 15px;
        }
        .marker {
            background-color: #add8e6;
            font-weight: bold;
        }
        .volgende {
            background-color: #fff8dc;
        }
        .toggle {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div id="formContainer">
    <h1>Haltes</h1>
    <form id="halteForm">
        <label>Entiteit:<input type="text" id="entiteit" required></label>
        <label>Lijnnummer:<input type="text" id="lijnnummer" required></label>
        <label>Richting:
            <select id="richting" required>
                <option value="HEEN">HEEN</option>
                <option value="TERUG">TERUG</option>
            </select>
        </label>
        <button type="submit">Toon haltes</button>
    </form>

    <div id="locatieControls">
        <button id="vernieuwLocatie">Locatie vernieuwen</button>
        <div class="toggle">
            <input type="checkbox" id="autoRefresh" />
            <label for="autoRefresh">Automatisch</label>
        </div>
    </div>
</div>

<div id="resultaat"><h2>Resultaat:</h2></div>

<script>
    let haltes = [];
    let markerHalte = null;
    let autoRefreshInterval = null;

    async function getUserLocation() {
        return new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(
                pos => resolve(pos.coords),
                err => reject(err),
                { enableHighAccuracy: true, timeout: 10000 }
            );
        });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const φ1 = lat1 * Math.PI / 180;
        const φ2 = lat2 * Math.PI / 180;
        const Δφ = (lat2 - lat1) * Math.PI / 180;
        const Δλ = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                  Math.cos(φ1) * Math.cos(φ2) *
                  Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function markeerDichtstbijzijndeHalte(userCoords) {
        if (haltes.length === 0 || !userCoords) return;

        let dichtste = haltes[0];
        let minAfstand = calculateDistance(userCoords.latitude, userCoords.longitude, dichtste.geoCoordinaat.latitude, dichtste.geoCoordinaat.longitude);

        haltes.forEach(h => {
            const afstand = calculateDistance(userCoords.latitude, userCoords.longitude, h.geoCoordinaat.latitude, h.geoCoordinaat.longitude);
            if (afstand < minAfstand) {
                dichtste = h;
                minAfstand = afstand;
            }
        });

        markerHalte = dichtste;
        toonHaltes();
    }

    function toonHaltes() {
        const container = document.getElementById('resultaat');
        container.innerHTML = "";

        let vorigeGemeente = null;
        let volgende = false;

        haltes.forEach((halte, index) => {
            if (halte.omschrijvingGemeente !== vorigeGemeente) {
                const gemeenteHeader = document.createElement('div');
                gemeenteHeader.className = 'gemeente';
                gemeenteHeader.textContent = halte.omschrijvingGemeente;
                container.appendChild(gemeenteHeader);
                vorigeGemeente = halte.omschrijvingGemeente;
            }

            const halteItem = document.createElement('li');
            halteItem.id = `halte-${halte.haltenummer}`;
            halteItem.textContent = halte.omschrijvingLang || halte.omschrijving;

            if (markerHalte && halte.haltenummer === markerHalte.haltenummer) {
                halteItem.classList.add('marker');
                volgende = true;
                setTimeout(() => {
                    halteItem.scrollIntoView({ behavior: "smooth", block: "center" });
                }, 100);
            } else if (volgende) {
                halteItem.classList.add('volgende');
                volgende = false;
            }

            container.appendChild(halteItem);
        });
    }

    document.getElementById('halteForm').addEventListener('submit', async e => {
        e.preventDefault();
        const entiteit = document.getElementById('entiteit').value;
        const lijnnummer = document.getElementById('lijnnummer').value;
        const richting = document.getElementById('richting').value;
        const url = `https://api.delijn.be/DLKernOpenData/api/v1/lijnen/${entiteit}/${lijnnummer}/lijnrichtingen/${richting}/haltes`;
        const apiKey = "ee23ac060f8a4038ad6d69358d85a1b0";

        try {
            const response = await fetch(url, {
                headers: {
                    "Cache-Control": "no-cache",
                    "Ocp-Apim-Subscription-Key": apiKey
                }
            });

            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const data = await response.json();
            haltes = data.haltes;

            try {
                const userCoords = await getUserLocation();
                markeerDichtstbijzijndeHalte(userCoords);
            } catch {
                markerHalte = haltes[0];
                toonHaltes();
            }

        } catch (error) {
            document.getElementById('resultaat').innerHTML = `<p style="color: red;">Fout: ${error.message}</p>`;
        }
    });

    document.getElementById('vernieuwLocatie').addEventListener('click', async () => {
        try {
            const userCoords = await getUserLocation();
            markeerDichtstbijzijndeHalte(userCoords);
        } catch (err) {
            alert("Kon locatie niet ophalen.");
        }
    });

    document.getElementById('autoRefresh').addEventListener('change', function () {
        if (this.checked) {
            autoRefreshInterval = setInterval(async () => {
                try {
                    const userCoords = await getUserLocation();
                    markeerDichtstbijzijndeHalte(userCoords);
                } catch {}
            }, 15000);
        } else {
            clearInterval(autoRefreshInterval);
        }
    });
</script>

</body>
</html>
