<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Halteweergave</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 20px;
      background-color: #f8f8f8;
    }
    input, button {
      font-size: 1em;
      padding: 10px;
      margin: 5px;
    }
    #halteLijst div {
      margin: 5px 0;
      padding: 8px;
      background: #e0e0e0;
      border-radius: 4px;
    }
    #haltescherm {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: white;
      z-index: 9999;
      padding: 20px;
      box-sizing: border-box;
    }
    #halteschermHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    #lijnDisplay {
      background-color: #007bff;
      color: white;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 1.2em;
    }
    #eindhalteDisplay {
      font-size: 1.2em;
    }
    #tijdDisplay {
      font-weight: bold;
      font-size: 1.2em;
    }
    #closeBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.2em;
      background: #ff4d4d;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <h2>üîç Zoek haltes op lijnnummer</h2>
  <input type="text" id="lijnnummer" placeholder="Bijv. 5" />
  <button id="zoekLijn">Zoek haltes</button>
  <button id="openHaltescherm">üé• Open Haltescherm</button>
  <div id="halteLijst"></div>

  <!-- Haltescherm weergave -->
  <div id="haltescherm">
    <button id="closeBtn">‚úñ</button>
    <div id="halteschermHeader">
      <div id="lijnDisplay">Lijn 0</div>
      <div id="eindhalteDisplay">Laatste halte</div>
      <div id="tijdDisplay">00:00</div>
    </div>
    <div id="halteContent"></div>
  </div>

  <script>
    let haltes = [];
    let halteschermInterval = null;

    document.getElementById("zoekLijn").addEventListener("click", async () => {
      const lijnnummer = document.getElementById("lijnnummer").value;
      if (!lijnnummer) return alert("Geef een lijnnummer in.");

      const response = await fetch(`https://data.delijn.be/OpenData/api/haltes?lijnnummer=${lijnnummer}`);
      haltes = await response.json();

      const lijst = document.getElementById("halteLijst");
      lijst.innerHTML = "";
      haltes.forEach(h => {
        const item = document.createElement("div");
        item.innerHTML = `<strong>${h.omschrijvingGemeente}</strong>: ${h.omschrijvingLang || h.omschrijving}`;
        lijst.appendChild(item);
      });
    });

    async function getUserLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve(pos.coords),
          err => reject(err)
        );
      });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const toRad = deg => deg * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function updateHaltescherm() {
      const tijdNow = new Date();
      document.getElementById("tijdDisplay").textContent = tijdNow.toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });

      document.getElementById("lijnDisplay").textContent = "Lijn " + document.getElementById("lijnnummer").value;
      document.getElementById("eindhalteDisplay").textContent = haltes[haltes.length - 1]?.omschrijving || "Laatste halte";

      getUserLocation().then(coords => {
        let dichtste = haltes[0];
        let minAfstand = calculateDistance(coords.latitude, coords.longitude, dichtste.geoCoordinaat.latitude, dichtste.geoCoordinaat.longitude);

        for (const h of haltes) {
          const afstand = calculateDistance(coords.latitude, coords.longitude, h.geoCoordinaat.latitude, h.geoCoordinaat.longitude);
          if (afstand < minAfstand) {
            minAfstand = afstand;
            dichtste = h;
          }
        }

        const content = document.getElementById("halteContent");
        content.innerHTML = "";

        if (minAfstand <= 100) {
          content.innerHTML = `
            <div style="text-align:center;">
              <div style="font-size:2em;">De huidige halte is:</div>
              <div style="font-size:4em; font-weight:bold;">${dichtste.omschrijvingGemeente},</div>
              <div style="font-size:2.5em;">${dichtste.omschrijvingLang || dichtste.omschrijving}</div>
            </div>
          `;
        } else {
          const index = haltes.findIndex(h => h.haltenummer === dichtste.haltenummer);
          const volgendeHaltes = haltes.slice(index, index + 8);

          const parelContainer = document.createElement("div");
          parelContainer.style.display = "flex";
          parelContainer.style.justifyContent = "center";
          parelContainer.style.alignItems = "flex-end";
          parelContainer.style.gap = "15px";

          volgendeHaltes.forEach((halte, i) => {
            const grootte = 2.5 - i * 0.2;
            const item = document.createElement("div");
            item.style.fontSize = `${grootte}em`;
            item.style.textAlign = "center";
            item.innerHTML = `
              <div style="font-weight:bold;">${halte.omschrijvingGemeente}</div>
              <div>${halte.omschrijvingLang || halte.omschrijving}</div>
            `;
            parelContainer.appendChild(item);
          });

          content.appendChild(parelContainer);
        }

      }).catch(() => {
        document.getElementById("halteContent").textContent = "Locatie niet beschikbaar.";
      });
    }

    document.getElementById("openHaltescherm").addEventListener("click", () => {
      if (haltes.length === 0) return alert("Laad eerst haltes.");
      document.getElementById("haltescherm").style.display = "block";
      updateHaltescherm();
      halteschermInterval = setInterval(updateHaltescherm, 7500);
    });

    document.getElementById("closeBtn").addEventListener("click", () => {
      document.getElementById("haltescherm").style.display = "none";
      clearInterval(halteschermInterval);
    });
  </script>
</body>
</html>
