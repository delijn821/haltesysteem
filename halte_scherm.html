
<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Lijn 40 - Aalst Station</title>
<style>

@font-face {
    font-family: 'FlandersArtSans';
    src: url('fonts/FlandersArtSans-Bold.woff') format('woff');
    font-weight: 600;
    font-style: normal;
}

@font-face {
    font-family: 'FlandersArtSans';
    src: url('fonts/FlandersArtSans-Medium.woff') format('woff');
    font-weight: 500;
    font-style: normal;
}

@font-face {
    font-family: 'FlandersArtSans';
    src: url('fonts/FlandersArtSans-Regular.woff') format('woff');
    font-weight: 400;
    font-style: normal;
}


body {
    font-family: 'FlandersArtSans', Arial, sans-serif;
    background-color: #111;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    height: 100vh;
    margin: 0;
    overflow: hidden;
    padding-top: 3%;
    padding-left: 5%;
    padding-right: 5%;
}

.header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.line-info {
    display: flex;
    align-items: center;
    gap: 20px;
}

.line-box {
    background-color: #15882E;
    color: #FFFFFF;
    -webkit-text-stroke: 2px #000;
    padding: 5px 20px;
    border-radius: 25px;
    font-size: 4.75em;
    font-weight: 600;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
}

.destination {
    font-size: 3.75em;
    font-weight: 500;
}

.clock {
    font-size: 3.5em;
    font-weight: 400;
}

.stops {
    display: flex;
    padding-top: 3%;
    flex-grow: 1;
    overflow: hidden;
    flex-direction: column;
    gap: 15px;
    font-size: 2.25em;
    font-weight: 500;
    width: 100%;
    text-align: left;
}

.stop {
    background-color: #333;
    border-radius: 15px;
    padding: 15px;
}

.footer {
    font-size: 3em;
    font-weight: 500;
    margin-top: auto;
    margin-bottom: 3%;
    width: 100%;
    text-align: center;
    padding: 2%;
    border-top: 2px solid #444;
}
</style>
</head>
<body>
<div class="header">
    <div class="line-info">
        <span class="line-box">40</span>
        <span class="destination">Aalst Station</span>
    </div>
    <div class="clock" id="clock"></div>
</div>

<div class="stops" id="stops-container"></div>

<div class="footer" id="next-stop">Volgende halte: —</div>

<script>
const haltes = [{"stop_name": "Londerzeel Station perron 4", "stop_lat": 51.008762, "stop_lon": 4.298598}, {"stop_name": "Londerzeel Chrysantenlaan", "stop_lat": 51.005627, "stop_lon": 4.302018}, {"stop_name": "Londerzeel Dorpsstraat", "stop_lat": 51.004133, "stop_lon": 4.301139}, {"stop_name": "Londerzeel Tramstraat", "stop_lat": 51.003171, "stop_lon": 4.295993}, {"stop_name": "Londerzeel Kapel Linde", "stop_lat": 51.002546, "stop_lon": 4.28623}, {"stop_name": "Londerzeel Lakeman", "stop_lat": 50.995729, "stop_lon": 4.282364}, {"stop_name": "Steenhuffel Kerk", "stop_lat": 50.995276, "stop_lon": 4.268671}, {"stop_name": "Steenhuffel Schoolstraat", "stop_lat": 50.993528, "stop_lon": 4.262054}, {"stop_name": "Steenhuffel Bontestraat", "stop_lat": 50.981787, "stop_lon": 4.253871}, {"stop_name": "Merchtem Molenstraat", "stop_lat": 50.975336, "stop_lon": 4.243916}, {"stop_name": "Merchtem Terlinden", "stop_lat": 50.969871, "stop_lon": 4.236543}, {"stop_name": "Merchtem Koutermolen", "stop_lat": 50.974151, "stop_lon": 4.231411}, {"stop_name": "Peizegem Tuinbouwschool", "stop_lat": 50.979176, "stop_lon": 4.231023}, {"stop_name": "Peizegem Kerkplein", "stop_lat": 50.98385, "stop_lon": 4.224487}, {"stop_name": "Peizegem Tuinbouwschool", "stop_lat": 50.979884, "stop_lon": 4.230051}, {"stop_name": "Merchtem Koutermolen", "stop_lat": 50.974807, "stop_lon": 4.231051}, {"stop_name": "Merchtem Sint-Janstraat", "stop_lat": 50.966218, "stop_lon": 4.231879}, {"stop_name": "Merchtem Ter Dreef", "stop_lat": 50.962546, "stop_lon": 4.231267}, {"stop_name": "Merchtem Burchtlaan", "stop_lat": 50.960863, "stop_lon": 4.233199}, {"stop_name": "Merchtem Varkensmarkt", "stop_lat": 50.958575, "stop_lon": 4.232357}, {"stop_name": "Merchtem Spiegellaan", "stop_lat": 50.961523, "stop_lon": 4.226389}, {"stop_name": "Opwijk Overweg", "stop_lat": 50.962736, "stop_lon": 4.213514}, {"stop_name": "Opwijk Klei", "stop_lat": 50.962114, "stop_lon": 4.208329}, {"stop_name": "Opwijk Steenweg op Merchtem", "stop_lat": 50.961539, "stop_lon": 4.202516}, {"stop_name": "Opwijk Hollestraat", "stop_lat": 50.966065, "stop_lon": 4.198062}, {"stop_name": "Opwijk Fabriekstraat", "stop_lat": 50.971657, "stop_lon": 4.189992}, {"stop_name": "Opwijk Station perron 1", "stop_lat": 50.974439, "stop_lon": 4.187542}, {"stop_name": "Opwijk Heirbaan", "stop_lat": 50.974496, "stop_lon": 4.18316}, {"stop_name": "Opwijk Marktstraat", "stop_lat": 50.971485, "stop_lon": 4.186684}, {"stop_name": "Opwijk Klaarstraat", "stop_lat": 50.969861, "stop_lon": 4.180306}, {"stop_name": "Opwijk Wijngaardstraat", "stop_lat": 50.968017, "stop_lon": 4.168196}, {"stop_name": "Opwijk Dageraadweg", "stop_lat": 50.966848, "stop_lon": 4.162734}, {"stop_name": "Opwijk Nijverseelstraat", "stop_lat": 50.962371, "stop_lon": 4.157055}, {"stop_name": "Opwijk Steenweg op Dendermonde", "stop_lat": 50.960848, "stop_lon": 4.153284}, {"stop_name": "Baardegem Melkspinde", "stop_lat": 50.957843, "stop_lon": 4.144669}, {"stop_name": "Baardegem Kerk", "stop_lat": 50.953984, "stop_lon": 4.140931}, {"stop_name": "Baardegem Bieseweide", "stop_lat": 50.951487, "stop_lon": 4.137331}, {"stop_name": "Baardegem Elderberg", "stop_lat": 50.951488, "stop_lon": 4.133813}, {"stop_name": "Meldert Kammenkouterstraat", "stop_lat": 50.949833, "stop_lon": 4.122077}, {"stop_name": "Meldert Koeisteert", "stop_lat": 50.948097, "stop_lon": 4.112951}, {"stop_name": "Moorsel Berggouw", "stop_lat": 50.950336, "stop_lon": 4.108141}, {"stop_name": "Moorsel Leirekenstraat", "stop_lat": 50.950684, "stop_lon": 4.10232}, {"stop_name": "Moorsel Dorp", "stop_lat": 50.947861, "stop_lon": 4.097941}, {"stop_name": "Moorsel Ten Berg", "stop_lat": 50.945718, "stop_lon": 4.092693}, {"stop_name": "Moorsel Koebrugstraat", "stop_lat": 50.944546, "stop_lon": 4.084117}, {"stop_name": "Aalst Achterweg", "stop_lat": 50.945473, "stop_lon": 4.073741}, {"stop_name": "Aalst Paardendries", "stop_lat": 50.944559, "stop_lon": 4.064025}, {"stop_name": "Aalst AZORG Moorselbaan", "stop_lat": 50.942912, "stop_lon": 4.055527}, {"stop_name": "Aalst Groenstraat", "stop_lat": 50.943891, "stop_lon": 4.048365}, {"stop_name": "Aalst Een Meistraat", "stop_lat": 50.94207, "stop_lon": 4.044431}, {"stop_name": "Aalst Station perron 1", "stop_lat": 50.942368, "stop_lon": 4.040014}];
// index van de halte die momenteel als "huidige" wordt beschouwd in de lijst
let lastClosestIndex = 0;
// onthoud vorige afstand naar "next" stop om te vergelijken of die afneemt
let prevNextDist = null;
// onthoud vorige afstand naar "current" (optioneel, kan gebruikt voor logging/extra checks)
let prevCurrentDist = null;
let lastDistanceToCurrent = null;
let currentStopScreen = false;
let sanityInterval = 300000;

// Update klok
function updateClock() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    document.getElementById('clock').textContent = hours + ':' + minutes;
}
setInterval(updateClock, 1000);
updateClock();

// Bereken afstand tussen 2 GPS-coördinaten (Haversine) -> meter
function distance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Render functie die de zichtbare haltes in DOM plaatst
function renderStops(startIndex) {
    const visible = haltes.slice(startIndex, startIndex + 5);
    const container = document.getElementById('stops-container');
    container.innerHTML = '';
    visible.forEach(h => {
        const div = document.createElement('div');
        div.className = 'stop';
        div.textContent = h.stop_name;
        container.appendChild(div);
    });
    const nextStop = visible.length > 1 ? visible[0].stop_name : 'Eindhalte bereikt';
    document.getElementById('next-stop').textContent = "Volgende halte: " + nextStop;
}

// initial render
renderStops(lastClosestIndex);

// Vraag GPS-locatie van apparaat en update
function getLocationAndUpdate() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                updateHaltes(lat, lon);
            },
            err => {
                console.warn("GPS-fout: " + err.message);
                // fallback op eerste halte
                updateHaltes(parseFloat(haltes[0].stop_lat), parseFloat(haltes[0].stop_lon));
            },
            {
                enableHighAccuracy: true,
                maximumAge: 5000,
                timeout: 10000
            }
        );
    } else {
        console.warn("Geolocatie niet ondersteund");
        updateHaltes(parseFloat(haltes[0].stop_lat), parseFloat(haltes[0].stop_lon));
    }
}

function updateHaltes(userLat, userLon) {
    if (!haltes || haltes.length === 0) return;

    const currentIndex = lastClosestIndex;
    const nextIndex = Math.min(currentIndex + 1, haltes.length - 1);

    const currentStop = haltes[currentIndex];
    const nextStop = haltes[nextIndex];

    const distCurrent = distance(userLat, userLon, currentStop.stop_lat, currentStop.stop_lon);
    const distNext = nextStop ? distance(userLat, userLon, nextStop.stop_lat, nextStop.stop_lon) : Infinity;

    // Activeer currentStopScreen als binnen 100m en afstand afneemt
    if (distCurrent < 100 && (lastDistanceToCurrent === null || distCurrent < lastDistanceToCurrent)) {
        currentStopScreen = true;
    }

    // Als de afstand tot huidige stop >30m en weer begint te stijgen, en afstand tot volgende afneemt -> opschuiven
    if (currentStopScreen && distCurrent > 30 && lastDistanceToCurrent !== null && distCurrent > lastDistanceToCurrent && distNext < previousDistanceToNext) {
        lastClosestIndex = nextIndex;
        currentStopScreen = false; // reset voor volgende halte
        renderStops(lastClosestIndex);
        console.log("➡️ Opschuiven naar:", haltes[lastClosestIndex].stop_name);
    }

    lastDistanceToCurrent = distCurrent;
    previousDistanceToNext = distNext;
}

function sanityCheck(userLat, userLon) {
    if (!haltes || haltes.length === 0) return;

    // Controleer de afstand tot vorige, huidige en volgende halte
    const prevIndex = Math.max(0, lastClosestIndex - 1);
    const nextIndex = Math.min(lastClosestIndex + 1, haltes.length - 1);

    const distPrev = distance(userLat, userLon, haltes[prevIndex].stop_lat, haltes[prevIndex].stop_lon);
    const distCurrent = distance(userLat, userLon, haltes[lastClosestIndex].stop_lat, haltes[lastClosestIndex].stop_lon);
    const distNext = distance(userLat, userLon, haltes[nextIndex].stop_lat, haltes[nextIndex].stop_lon);

    // Als de gebruiker duidelijk dichter bij een andere halte is, corrigeer lastClosestIndex
    if (distPrev < distCurrent && distPrev < distNext) lastClosestIndex = prevIndex;
    else if (distNext < distCurrent && distNext < distPrev) lastClosestIndex = nextIndex;

    renderStops(lastClosestIndex);
}
setInterval(() => {
    navigator.geolocation.getCurrentPosition(
        pos => sanityCheck(pos.coords.latitude, pos.coords.longitude),
        err => console.warn("Sanity GPS-fout:", err.message)
    );
}, sanityInterval);


// eerste aanroep + interval
getLocationAndUpdate();
setInterval(getLocationAndUpdate, 3000);
</script>
</body>
</html>
